* Introduction

Ioat is a processing chain developed by the [[http://www.cesbio.ups-tlse.fr][CESBIO]] : [Centre d'Etude Spatiales de la BIOshph√®re] which produces a land cover image
like this one.[mettre un lien en local ou vers page web, ou rien ?]

Every datas you need are resumed into the "What you need" section.
Before launching the chain it is necessary to declare, thanks to a configuration file, where and how are stored datas. 
It is this configuration file which rules all the test. All parameters of this file are detailed inside the "How to configure Iota" section. 
When inputs are ready, you can launch the chain as described in the next section : "How to launch Iota"

* What you need

You need to get OTB 5.0 or greater and some other python packages:
- argparse
- gdal,ogr
- config
as already mentioned, you also need to fill out a configuration file.

* How to configure Iota

Currently a configuration file is divided in four parts: Chain, learning, classification, and features. All parts contain fields described below.
Some parameters are directly linked to OTB functions, so for these parameters please refer to [[https://www.orfeo-toolbox.org/documentation/][OTB cookbook]]

** Chain

This part corresponds to the general description of the test.

| field            | Description                                                                                                                                     | Conditions                                           | Example                                                                                    |
|------------------+-------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------+--------------------------------------------------------------------------------------------|
| type             | this argument determine the chain's launching mode (sequential or parallel)                                                                    | must be 'parallel' or 'sequential'                   | type : 'sequential'                                                                        |
| testPath         | root path to the test folder                                                                                                                    | must not contain '*classif*'                          | testPath : '/root/path/to/Test/'                                                           |
| jobsPath         | root path to the job folder. If the folder does not exist, he will be created. If jobs already exist inside the folder, they will be overwritten | only for parallel mode                               | jobsPath : '/root/path/to/Jobs/'                                                           |
| pyAppPath        | root path to the Iota python's script                                                                                                           | -                                                    | pyAppPath : '/root/path/to/PyApp/'                                                         |
| chainName        | the name of the file which will contain the chain                                                                                                  | if the name already exist, he will be overwritten.    | chainName : 'MyFirstChain'                                                                 |
| nomenclaturePath | root path to the nomenclature description                                                                                                       | the file must respect (1) syntax                    | nomenclaturePath : '/to/Nomenclature.csv'                                                  |
| listTile         | list of tiles to consider                                                                                                                       | must respect the example syntax                     | listTile : 'D0003H0001 D0008H0004'                                                         |
| featuresPath     | root path to features                                                                                                                           | -                                                    | featuresPath : '/to/features/path/'                                                        |
| L8Path           | root path to the raw Landsat_8 images                                                                                                           | the L8 folder must be organize by tile               | L8Path : '/to/L8/Path/' which contains two folders (for example) D0003H0001 and D0008H0004 |
| S2Path           | same as L8Path but for Sentinel_2 images (not available)                                                                                        |                                                      |                                                                                            |
| S1Path           | same as L8Path but for Sentinel_1 images (not available)                                                                                        |                                                      |                                                                                            |
| groundTruth      | root path to ground truth                                                                                                                       | the ground truth must be a shapeFile                 | groundTruth : '/to/my/groundTruth.shp'                                                     |
| dataField        | field that discriminates datas into the ground truth shapeFile                                                                                  | that field must contain integer                     | dataField : 'My_int_Data'                                                                  |
| mode             | models repartition mode among tiles                                                                                                             | must be 'multi_regions','one_region' or 'outside'(2) | mode : 'multi_regions'                                                                     |
| regionPath       | root path to the shapeFile which contains regions. This file will be created if the field 'mode' is different from 'outside'                   | must be a shapeFile                                  | regionPath : '/to/my/region.shp'                                                           |
| regionField      | field that discriminates regions into the region shapeFile                                                                                      | that field must contain integer                     | regionField : 'My_int_region'                                                              |
| model            | root path to the file which link tiles and their belonging model                                                                                | that file must respect a syntax as explain in  (3)  | model : '/to/my/modelDescription.txt'                                                      |
| sample           | number of random sample for training and validation                                                                                             | must be a string different from 0                    | sample : '1'                                                                               |
| logPath          | root path to the folder which will contains log files                                                                                           | only for parallel mode                                | logPath : '/to/my/log/folder/'                                                             |

(1) Example of file describing nomenclature (lien vers fichier local?)

$ cat Nomenclature.csv

#+BEGIN_EXAMPLE
summer:11
winter:12
corn:44
town:41
#+END_EXAMPLE

/!\ no empty line.

(2) Description of the different models repartition mode  

 - multi_regions mode :
             many models will be learned for the classification. Tiles use in order to build a model are described into the file informed by the field 'model'. 
 - one_region mode : 
             means that only one model will be build for the classification. All tiles in 'listTiles' will be used to learn that model.
 - outside mode : 
             in this mode, the regions shape is provided by the user.

(3) Example of a file which link tiles and their belonging model

$ cat modelDescription.txt

#+BEGIN_EXAMPLE
r1 : D0001H0002,D0001H0003
r2 : D0002H0003
r3 : D0002H0002,D0002H0003,D0002H0001
#+END_EXAMPLE

This example means three models, the first model is built using two tiles : D0001H0002,D0001H0003 etc...
/!\ One line in the file means one model. The file does not have empty line.

** training

This part is dedicated to the learning mode.

| field      | Description        | Conditions          | Example                          |
|------------+--------------------+---------------------+----------------------------------|
| classifier | the classifier asks | should exist in OTB | classifier : 'rf'                |
| options    | classifier options | should exist in OTB | options : '-classifier.rf.min 5' |

** classifications

Classification's options

| field         | Description                                                                   | Conditions                         | Example                                                 |
|---------------+-------------------------------------------------------------------------------+------------------------------------+---------------------------------------------------------|
| classifMode   | argument uses in order to indicate if fusion of classification will be used (1) | must be 'fusion' or 'separate'     | classifMode : 'fusion'                                  |
| fusionOptions | parameters for fusion of classification                                       | these parameters must exist in OTB | fusionOptions : '-nodatalabel 0 -method majorityvoting' |

(1) Explanation about classifMode's options

- separate :
    every pixels are labelled only by one model, the one which learn the region where the pixel is. 

- fusion : 
    every models labelled every pixel. When a decision can not be taken by the fusion function, the label is chosen by the classification produced by the model which learn the region where the pixel is. 

** features

Today, features computed are : NDVI, NDWI and the brightness. Only one sensor is supported, Landsat_8, but some others are coming soon. So you only have to fill out the Landsat_8 block composed by many fields. 

| field       | Description                                                        | Conditions                | Example                                                                       |
|-------------+--------------------------------------------------------------------+---------------------------+-------------------------------------------------------------------------------|
| nodata_Mask | argument used to indicate if a NoData mask exists                    | must be 'False' or 'True' | nodata_Mask : 'False'                                                         |
| nativeRes   | native resolution of images                                        | must be an integer        | nativeRes : 30                                                                |
| arbo        | inform the image's path, according to L8Path (1)                   | -                         | arbo : /*/*                                                                   |
| imtype      | allow you to target a specific images in arbo                      | -                         | imtype : "ORTHO_SURF_CORR_PENTE*.TIF"                                         |
| arbomask    | inform the path of the mask link to the image, according to L8Path | -                         | arbomask : "*/*/MASK/"                                                        |
| nuages      | target the mask of cloud in arbomask                               | -                         | nuages : "NUA.TIF"                                                            |
| saturation  | target the mask of saturation in arbomask                          | -                         | saturation : "SAT.TIF"                                                        |
| div         | target the mask of diverse in arbomask                             | -                         | div : "DIV.TIF"                                                               |
| nodata      | target the nodata mask in arbomask                                 | -                         | nodata : "NODATA.TIF" if nodata_Mask is set to 'False', nodata could be : "" |




(1) Explanation about how to store images

    images must be stored by tiles.
    for example : /path/Landsat8_T/X/Y.tif
    - T : a tile name according to Theia definition : D0001H0005 or D0002H0004 ...
    - X : a folder
    - Y : the image
    
    In that example, L8Path : '/path/' and arbo : '/*/*'
    arbo is the path from L8Path, to find the image.tif    

Once the configuration file fill out, the chain can be launch.

* How to launch Iota

you only have to launch the launcher:

cd /path/to/the/python/script
. launchChain.sh /path/to/the/configuration/file.cfg
